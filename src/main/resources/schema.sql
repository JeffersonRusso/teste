-- =================================================================================
-- LIMPEZA TOTAL (DROP DE TABELAS ANTIGAS)
-- =================================================================================
DROP TABLE IF EXISTS tb_global_cache;
DROP TABLE IF EXISTS tb_tag_rule;
DROP TABLE IF EXISTS tb_pipeline_node_decorator;
DROP TABLE IF EXISTS tb_decorator_template;
DROP TABLE IF EXISTS tb_pipeline_node;
DROP TABLE IF EXISTS tb_task_template;
DROP TABLE IF EXISTS tb_pipeline_version;
DROP TABLE IF EXISTS tb_input_normalization;

-- ... (tabelas 1, 2 e 3 mantidas)

-- =================================================================================
-- 1. NORMALIZAÇÃO DE ENTRADA
-- =================================================================================
CREATE TABLE tb_input_normalization (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    operation_type VARCHAR(50) NOT NULL,
    target_field VARCHAR(50) NOT NULL,
    source_expression VARCHAR(255) NOT NULL,
    transformation_expression VARCHAR(255)
);

-- =================================================================================
-- 2. VERSÃO DO PIPELINE
-- =================================================================================
CREATE TABLE tb_pipeline_version (
    pipeline_id UUID PRIMARY KEY,
    operation_type VARCHAR(50) NOT NULL,
    version INT NOT NULL,
    timeout_ms BIGINT NOT NULL DEFAULT 30000,
    input_mapping TEXT DEFAULT '{}',
    required_outputs TEXT DEFAULT '[]',
    is_active BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(operation_type, version)
);

-- =================================================================================
-- 3. TEMPLATES DE TASKS
-- =================================================================================
CREATE TABLE tb_task_template (
    template_id VARCHAR(50) PRIMARY KEY,
    type VARCHAR(20) NOT NULL,
    base_configuration TEXT NOT NULL,
    description VARCHAR(255)
);

-- =================================================================================
-- 4. NÓS DO PIPELINE (INSTÂNCIAS)
-- =================================================================================
CREATE TABLE tb_pipeline_node (
    node_id UUID PRIMARY KEY,
    pipeline_id UUID NOT NULL,
    template_id VARCHAR(50),
    name VARCHAR(50) NOT NULL,
    type VARCHAR(20),
    configuration TEXT, -- TUDO (incluindo cron) VAI AQUI
    inputs TEXT DEFAULT '{}',
    outputs TEXT DEFAULT '{}',
    activation_tags TEXT DEFAULT '["default"]',
    guard_condition VARCHAR(500),
    fail_fast BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (pipeline_id) REFERENCES tb_pipeline_version(pipeline_id),
    FOREIGN KEY (template_id) REFERENCES tb_task_template(template_id)
);

CREATE INDEX idx_node_pipeline ON tb_pipeline_node(pipeline_id);

-- ... (tabelas 5, 6, 7 e 8 mantidas)
CREATE TABLE tb_decorator_template (
    template_id VARCHAR(50) PRIMARY KEY,
    type VARCHAR(50) NOT NULL,
    phase VARCHAR(20) NOT NULL DEFAULT 'AROUND',
    default_configuration TEXT NOT NULL,
    description VARCHAR(255)
);

CREATE TABLE tb_pipeline_node_decorator (
    node_id UUID NOT NULL,
    template_id VARCHAR(50) NOT NULL,
    override_configuration TEXT,
    execution_order INT NOT NULL DEFAULT 0,
    PRIMARY KEY (node_id, template_id),
    FOREIGN KEY (node_id) REFERENCES tb_pipeline_node(node_id),
    FOREIGN KEY (template_id) REFERENCES tb_decorator_template(template_id)
);

CREATE TABLE tb_tag_rule (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    tag_name VARCHAR(50) NOT NULL,
    condition_expression VARCHAR(500) NOT NULL,
    priority INT NOT NULL DEFAULT 0,
    is_active BOOLEAN DEFAULT TRUE
);

CREATE TABLE tb_global_cache (
    cache_key VARCHAR(100) PRIMARY KEY,
    cache_value TEXT NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
